<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>File Storage &mdash; The Ape 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="The Ape 0.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Storage" href="index.html" />
    <link rel="next" title="theape.parts.storage.filestorage.FileStorage" href="api/theape.parts.storage.filestorage.FileStorage.html" />
    <link rel="prev" title="theape.parts.storage.csvstorage.CsvDictStorage.writerows" href="api/theape.parts.storage.csvstorage.CsvDictStorage.writerows.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="api/theape.parts.storage.filestorage.FileStorage.html" title="theape.parts.storage.filestorage.FileStorage"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="api/theape.parts.storage.csvstorage.CsvDictStorage.writerows.html" title="theape.parts.storage.csvstorage.CsvDictStorage.writerows"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Ape Documentation</a> &raquo;</li>
          <li><a href="../index.html" >Parts</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Storage</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="file-storage">
<h1>File Storage<a class="headerlink" href="#file-storage" title="Permalink to this headline">¶</a></h1>
<p>This is a module for classes that implement a file-like interface to disk-files but also add some extra features meant to make them easier to use within the APE.</p>
<div class="section" id="filestorage-model">
<span id="file-storage-model"></span><h2>FileStorage Model<a class="headerlink" href="#filestorage-model" title="Permalink to this headline">¶</a></h2>
<p>Since the ultimate model for all storage classes is <tt class="docutils literal"><span class="pre">__builtin__.file</span></tt> (see: <em class="xref std std-ref">exploring files</em> for the API and some notes), this class will implement all the non-optional methods and attributes. In addition it will inherit from the <a class="reference internal" href="../../components/component.html#composite-class"><em>Composite</em></a> in order to allow non-homogeneous storage (e.g. stdout and disk &#8211; the equivalent of the unix <cite>tee</cite>).</p>
<p class="plantuml">
<img src="../../_images/plantuml-91fb4cba792ff326687a14a464598533145c1c70.png" alt="FileStorage : FileStorage __init__(path, [,mode])
FileStorage : open(name[, mode])
FileStorage : close()
FileStorage : flush()
FileStorage : String read()
FileStorage : String readline()
FileStorage : List readlines()
FileStorage : write(text)
FileStorage : writeline(text)
FileStorage : writelines(list)
FileStorage : closed
FileStorage : mode
FileStorage : name
FileStorage : path
FileStorage : add(component)
FileStorage : components
FileStorage : __enter__
FileStorage : __exit__
FileStorage : __iter__" />
</p>
</div>
<div class="section" id="extras">
<span id="file-storage-extras"></span><h2>Extras<a class="headerlink" href="#extras" title="Permalink to this headline">¶</a></h2>
<p>Although the built-in <tt class="docutils literal"><span class="pre">file</span></tt> is the model for the <tt class="docutils literal"><span class="pre">FileStorage</span></tt>, it wouldn&#8217;t make much sense to replicate it exactly. The main impetus for creating this (besides keeping an eye on non-disk output in the future) is to have something that can keep track of extra persistent data &#8211; in particular:</p>
<blockquote>
<div><ul class="simple">
<li>Sub-folders</li>
<li>Existing files with redundant names (and how to handle them)</li>
<li>Time-stamps</li>
<li>Locks</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="sub-folders">
<span id="file-storage-sub-folders"></span><h2>Sub-Folders<a class="headerlink" href="#sub-folders" title="Permalink to this headline">¶</a></h2>
<p>In order to help tame the explosion of files that can often happen from the repeated execution of code that collects data the FileStorage will accept a path which it will then prepend to any file-name when it is opened. If the sub-folder does not exist it will be created.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">IN_PWEAVE</span><span class="p">:</span>
    <span class="n">example_path</span> <span class="o">=</span> <span class="s">&#39;aoeu/snth&#39;</span>
    <span class="n">example_file</span> <span class="o">=</span> <span class="s">&#39;umma.gumma&#39;</span>


    <span class="c"># this is the part that should be part of the path property</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">example_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">example_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;aoeu&#39;</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c"># this will be run multiple times, remove the example so it gets started fresh</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">example_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">example_path</span><span class="p">)</span>
</pre></div>
</div>
<div class="code highlight-python"><div class="highlight"><pre><span class="n">snth</span>
</pre></div>
</div>
</div>
<div class="section" id="redundant-files">
<span id="file-storage-redundant-files"></span><h2>Redundant Files<a class="headerlink" href="#redundant-files" title="Permalink to this headline">¶</a></h2>
<p>It often happens that data-collecting code will be run multiple times. The two ways proposed to avoid inadvertently overriding files are:</p>
<blockquote>
<div><ul class="simple">
<li>Appending count-numbers (e.g. a_0.txt, a_1.txt)</li>
<li>Adding Timestamps</li>
</ul>
</div></blockquote>
<p>The first scheme is more easily generalizable, while the second adds more useful information. It will therefore be assumed that both will be implemented and the increment scheme will only come into effect in the cases where the two files of the same name have been requested in too short a time-interval for the timestamps to differentiate them.</p>
<div class="section" id="adding-timestamps">
<h3>Adding Timestamps<a class="headerlink" href="#adding-timestamps" title="Permalink to this headline">¶</a></h3>
<p>The timestamp will be added using string formatting &#8211; it will look for a <cite>timestamp</cite> keyword:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">IN_PWEAVE</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;test_{timestamp}.csv&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">FILE_TIMESTAMP</span><span class="p">)))</span>
</pre></div>
</div>
<div class="code highlight-python"><div class="highlight"><pre>test_2015_01_15_04:48:15_PM.csv
</pre></div>
</div>
</div>
<div class="section" id="appending-increments">
<h3>Appending Increments<a class="headerlink" href="#appending-increments" title="Permalink to this headline">¶</a></h3>
<p>In the event that no <cite>timestamp</cite> formatting was added or the files were created less than a second apart, the <cite>FileStorage</cite> will add a count to the end of the base file-name prefix.</p>
</div>
<div class="section" id="side-effects">
<h3>Side Effects<a class="headerlink" href="#side-effects" title="Permalink to this headline">¶</a></h3>
<p>Because the name is being made to never match an existing file, the FileStorage can only write files, not read them. A separate file-reader needs to be built if that&#8217;s something needed.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">IN_PWEAVE</span><span class="p">:</span>
    <span class="c"># what&#39;s here?</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;txt&#39;</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;innagaddadavida.txt&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_name</span><span class="p">):</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">digit</span> <span class="o">=</span> <span class="s">r&#39;\d&#39;</span>
        <span class="n">one_or_more</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span>
        <span class="n">underscore</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span>

        <span class="n">suffix</span> <span class="o">=</span> <span class="n">underscore</span> <span class="o">+</span> <span class="n">digit</span> <span class="o">+</span> <span class="n">one_or_more</span>
        <span class="n">expression</span> <span class="o">=</span> <span class="s">r&quot;{b}{s}{e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">base</span><span class="p">,</span>
                                          <span class="n">s</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
                                            <span class="n">e</span><span class="o">=</span><span class="n">extension</span><span class="p">)</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;{b}_{c}{e}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">base</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">extension</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<div class="code highlight-python"><div class="highlight"><pre><span class="n">innagaddadavida</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="module-theape.parts.storage.filestorage">
<span id="filestorage-api"></span><span id="file-storage-api"></span><h2>FileStorage API<a class="headerlink" href="#module-theape.parts.storage.filestorage" title="Permalink to this headline">¶</a></h2>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.html#theape.parts.storage.filestorage.FileStorage" title="theape.parts.storage.filestorage.FileStorage"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage</span></tt></a>([path,&nbsp;timestamp,&nbsp;name,&nbsp;...])</td>
<td>A class to store data to a file</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.path.html#theape.parts.storage.filestorage.FileStorage.path" title="theape.parts.storage.filestorage.FileStorage.path"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage.path</span></tt></a></td>
<td>The path to prepend to files (cwd if not set by client)</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.safe_name.html#theape.parts.storage.filestorage.FileStorage.safe_name" title="theape.parts.storage.filestorage.FileStorage.safe_name"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage.safe_name</span></tt></a>(name[,&nbsp;overwrite])</td>
<td>Adds a timestamp if formatted for it, increments if already exists</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.open.html#theape.parts.storage.filestorage.FileStorage.open" title="theape.parts.storage.filestorage.FileStorage.open"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage.open</span></tt></a>(name[,&nbsp;overwrite,&nbsp;mode,&nbsp;...])</td>
<td>Opens a file for writing</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.close.html#theape.parts.storage.filestorage.FileStorage.close" title="theape.parts.storage.filestorage.FileStorage.close"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage.close</span></tt></a>()</td>
<td>Closes self.file if it exists, sets self.closed to True</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.write.html#theape.parts.storage.filestorage.FileStorage.write" title="theape.parts.storage.filestorage.FileStorage.write"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage.write</span></tt></a>(text[,&nbsp;exceptions])</td>
<td>Writes the text to the file</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.writeline.html#theape.parts.storage.filestorage.FileStorage.writeline" title="theape.parts.storage.filestorage.FileStorage.writeline"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage.writeline</span></tt></a>(text)</td>
<td>Adds newline to end of text and writes it to the file</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="api/theape.parts.storage.filestorage.FileStorage.writelines.html#theape.parts.storage.filestorage.FileStorage.writelines" title="theape.parts.storage.filestorage.FileStorage.writelines"><tt class="xref py py-obj docutils literal"><span class="pre">FileStorage.writelines</span></tt></a>(texts[,&nbsp;exceptions])</td>
<td>Writes the lines to the file</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="filestorage-definition">
<h2>FileStorage Definition<a class="headerlink" href="#filestorage-definition" title="Permalink to this headline">¶</a></h2>
<div class="section" id="constructor">
<h3>Constructor<a class="headerlink" href="#constructor" title="Permalink to this headline">¶</a></h3>
<p>The constructor takes two parameters:</p>
<blockquote>
<div><ul class="simple">
<li>path</li>
<li>timestamp</li>
</ul>
</div></blockquote>
<p>The <tt class="docutils literal"><span class="pre">path</span></tt> is the main reason for using the <tt class="docutils literal"><span class="pre">FileStorage</span></tt> &#8211; by keeping it persistent it frees the users of the <tt class="docutils literal"><span class="pre">FileStorage</span></tt> from having to know about sub-folders. The <tt class="docutils literal"><span class="pre">timestamp</span></tt> is a <cite>strftime</cite> string-format. The default is stored in the global-space of this module as a constant called <tt class="docutils literal"><span class="pre">FILE_TIMESTAMP</span></tt>.</p>
</div>
<div class="section" id="the-open-method">
<h3>The <tt class="docutils literal"><span class="pre">open</span></tt> Method<a class="headerlink" href="#the-open-method" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">open</span></tt> method is where things get kind of different from a regular file (and may not be a good idea if examined too closely). In order to preserve the path a copy of the <tt class="docutils literal"><span class="pre">FileStorage</span></tt> is created and a new opened-file is added to it before returning the copy.</p>
<p>Path:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Append an integer if needed (or asked for) to requested filename to prevent over-writing an existing file with the same name</li>
<li>Create a copy of the FileStorage</li>
<li>Open a writeable file-object using the (possibly fixed) filename</li>
<li>Set the FileStorage copy&#8217;s <tt class="docutils literal"><span class="pre">file</span></tt> attribute to the opened file</li>
<li>Set the mode for the FileStorage copy</li>
<li>Set the <cite>closed</cite> attribute of the copy to False</li>
<li>Return the new FileStorage copy</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="module-diagram">
<span id="file-storage-module-diagram"></span><h2>Module Diagram<a class="headerlink" href="#module-diagram" title="Permalink to this headline">¶</a></h2>
<p>[Errno 2] No such file or directory
Is pylint installed?
.. image:: classes_filestorage.png</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">File Storage</a><ul>
<li><a class="reference internal" href="#filestorage-model">FileStorage Model</a></li>
<li><a class="reference internal" href="#extras">Extras</a></li>
<li><a class="reference internal" href="#sub-folders">Sub-Folders</a></li>
<li><a class="reference internal" href="#redundant-files">Redundant Files</a><ul>
<li><a class="reference internal" href="#adding-timestamps">Adding Timestamps</a></li>
<li><a class="reference internal" href="#appending-increments">Appending Increments</a></li>
<li><a class="reference internal" href="#side-effects">Side Effects</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-theape.parts.storage.filestorage">FileStorage API</a></li>
<li><a class="reference internal" href="#filestorage-definition">FileStorage Definition</a><ul>
<li><a class="reference internal" href="#constructor">Constructor</a></li>
<li><a class="reference internal" href="#the-open-method">The <tt class="docutils literal"><span class="pre">open</span></tt> Method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-diagram">Module Diagram</a></li>
</ul>
</li>
</ul>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/user/index.html">User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/developer/index.html">Developer Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../log_setter.html">Log Setter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main.html">The Main Entry Point</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">The APE (Read Me)</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../components/index.html">The Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">The Ape&#8217;s Infrastructure</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Parts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Plugins</a></li>
</ul>


<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014, the cloistered monkey.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.6.2</a>
      
      |
      <a href="../../_sources/parts/storage/filestorage.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>